<!DOCTYPE html>
<html>
<body>
<canvas id="pendulum" width="250" height="400" style="background:#000;"></canvas>
<script>
const canvas = document.getElementById('pendulum');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

let t = 0, dt = 1/60;
let state = [Math.PI*0.99, Math.PI*0.95, 0, 0];
let trail = [];
let lastPush = 0;

const l1 = 80, l2 = 80;
const m1 = 5.0, m2 = 3.0;
const g = 9.81;
const pivot = {x: W/2, y: 80};
const trailLength = 200;

function deriv(state) {
    const [th1, th2, w1, w2] = state;
    const cos12 = Math.cos(th1 - th2);
    const sin12 = Math.sin(th1 - th2);
    const den = m1 + m2*sin12*sin12;
    const a1 = (m2*g*Math.sin(th2)*cos12 - m2*l2*w2*w2*sin12 - (m1+m2)*g*Math.sin(th1)) / (l1*den);
    const a2 = ((m1+m2)*(g*Math.sin(th1)*cos12 + l1*w1*w1*sin12 - g*Math.sin(th2))) / (l2*den);
    return [w1, w2, a1, a2];
}

function rk4(state, dt) {
    const k1 = deriv(state);
    const k2 = deriv(state.map((s,i) => s + dt/2*k1[i]));
    const k3 = deriv(state.map((s,i) => s + dt/2*k2[i]));
    const k4 = deriv(state.map((s,i) => s + dt*k3[i]));
    return state.map((s,i) => s + dt/6*(k1[i] + 2*k2[i] + 2*k3[i] + k4[i]));
}

function push() {
    state[2] += 25;
    state[3] += -15;
}

function update() {
    t += dt;
    if (t - lastPush > 10) {
        push();
        lastPush = t;
    }
    state = rk4(state, dt);
    
    const [th1, th2, w1, w2] = state;
    const x1 = pivot.x + l1*Math.sin(th1);
    const y1 = pivot.y + l1*Math.cos(th1);
    const x2 = x1 + l2*Math.sin(th2);
    const y2 = y1 + l2*Math.cos(th2);
    
    trail.push({x: x2, y: y2, w: w2});
    if (trail.length > trailLength) trail.shift();
}

function draw() {
    ctx.clearRect(0, 0, W, H);
    
    const [th1, th2] = state;
    const x1 = pivot.x + l1*Math.sin(th1);
    const y1 = pivot.y + l1*Math.cos(th1);
    const x2 = x1 + l2*Math.sin(th2);
    const y2 = y1 + l2*Math.cos(th2);
    
    ctx.beginPath();
    for (let i = 0; i < trail.length; i++) {
        const p = trail[i];
        const hue = 240 + Math.min(120, Math.max(-120, p.w*5));
        ctx.strokeStyle = `hsl(${hue},100%,50%)`;
        ctx.lineWidth = 2;
        if (i === 0) ctx.moveTo(p.x, p.y);
        else {
            ctx.lineTo(p.x, p.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
        }
    }
    
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(pivot.x, pivot.y);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    
    ctx.fillStyle = '#0af';
    ctx.beginPath();
    ctx.arc(x1, y1, m1, 0, Math.PI*2);
    ctx.fill();
    
    ctx.fillStyle = '#f0a';
    ctx.beginPath();
    ctx.arc(x2, y2, m2, 0, Math.PI*2);
    ctx.fill();
    
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(pivot.x, pivot.y, 3, 0, Math.PI*2);
    ctx.fill();
}

function animate() {
    update();
    draw();
    requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>