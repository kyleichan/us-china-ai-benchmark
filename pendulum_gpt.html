<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=250,height=400,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
html,body{margin:0;padding:0;width:250px;height:400px;overflow:hidden;background:#07090f}
canvas{display:block;width:250px;height:400px}
</style>
</head>
<body>
<canvas id="c" width="250" height="400"></canvas>
<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false });

  const W = canvas.width, H = canvas.height;
  const origin = { x: W * 0.5, y: H * 0.22 };

  const g = 9.81;

  const L1 = 0.95;
  const L2 = 0.85;
  const m1 = 1.2;
  const m2 = 1.0;

  const pxPerM = 120;

  let th1 = Math.PI - 0.23;
  let th2 = Math.PI - 0.32;
  let w1 = 0.0;
  let w2 = 0.0;

  const trail = [];
  const TRAIL_MAX = 1400;

  let t = 0;
  let nextKick = 10;

  function accels(th1, th2, w1, w2) {
    const s12 = Math.sin(th1 - th2);
    const c12 = Math.cos(th1 - th2);
    const denom1 = (2*m1 + m2 - m2*Math.cos(2*th1 - 2*th2));
    const denom2 = denom1;

    const a1 = (
      -g*(2*m1 + m2)*Math.sin(th1)
      -m2*g*Math.sin(th1 - 2*th2)
      -2*s12*m2*(w2*w2*L2 + w1*w1*L1*c12)
    ) / (L1*denom1);

    const a2 = (
      2*s12*(
        w1*w1*L1*(m1 + m2)
        + g*(m1 + m2)*Math.cos(th1)
        + w2*w2*L2*m2*c12
      )
    ) / (L2*denom2);

    return [a1, a2];
  }

  function rk4Step(dt) {
    const k1 = accels(th1, th2, w1, w2);
    const th1_2 = th1 + 0.5*dt*w1;
    const th2_2 = th2 + 0.5*dt*w2;
    const w1_2 = w1 + 0.5*dt*k1[0];
    const w2_2 = w2 + 0.5*dt*k1[1];

    const k2 = accels(th1_2, th2_2, w1_2, w2_2);
    const th1_3 = th1 + 0.5*dt*w1_2;
    const th2_3 = th2 + 0.5*dt*w2_2;
    const w1_3 = w1 + 0.5*dt*k2[0];
    const w2_3 = w2 + 0.5*dt*k2[1];

    const k3 = accels(th1_3, th2_3, w1_3, w2_3);
    const th1_4 = th1 + dt*w1_3;
    const th2_4 = th2 + dt*w2_3;
    const w1_4 = w1 + dt*k3[0];
    const w2_4 = w2 + dt*k3[1];

    const k4 = accels(th1_4, th2_4, w1_4, w2_4);

    th1 += dt*(w1 + 2*w1_2 + 2*w1_3 + w1_4)/6;
    th2 += dt*(w2 + 2*w2_2 + 2*w2_3 + w2_4)/6;
    w1  += dt*(k1[0] + 2*k2[0] + 2*k3[0] + k4[0])/6;
    w2  += dt*(k1[1] + 2*k2[1] + 2*k3[1] + k4[1])/6;

    const damp = Math.exp(-dt*0.012);
    w1 *= damp;
    w2 *= damp;
  }

  function pos() {
    const x1 = origin.x + pxPerM * L1 * Math.sin(th1);
    const y1 = origin.y + pxPerM * L1 * Math.cos(th1);
    const x2 = x1 + pxPerM * L2 * Math.sin(th2);
    const y2 = y1 + pxPerM * L2 * Math.cos(th2);
    return [x1,y1,x2,y2];
  }

  function hueFromOmega(omega) {
    const a = Math.min(1, Math.abs(omega) / 10);
    const hue = 220 - 200*a;
    const sat = 95;
    const light = 55;
    return `hsl(${hue.toFixed(1)} ${sat}% ${light}%)`;
  }

  function draw() {
    ctx.fillStyle = '#07090f';
    ctx.fillRect(0,0,W,H);

    if (trail.length > 1) {
      ctx.lineWidth = 1.2;
      ctx.lineCap = 'round';
      for (let i = 1; i < trail.length; i++) {
        const p0 = trail[i-1], p1 = trail[i];
        const age = (trail.length - 1 - i) / (trail.length - 1);
        const alpha = Math.max(0, 0.85*(1 - age*age*0.9));
        ctx.strokeStyle = p1.c.replace(')', ` / ${alpha.toFixed(3)})`).replace('hsl', 'hsla');
        ctx.beginPath();
        ctx.moveTo(p0.x, p0.y);
        ctx.lineTo(p1.x, p1.y);
        ctx.stroke();
      }
    }

    const [x1,y1,x2,y2] = pos();

    ctx.strokeStyle = 'rgba(220,230,255,0.75)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(origin.x, origin.y);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();

    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.beginPath();
    ctx.arc(origin.x, origin.y, 3, 0, Math.PI*2);
    ctx.fill();

    const r1 = 7 + 2.0*Math.cbrt(m1);
    const r2 = 7 + 2.0*Math.cbrt(m2);

    ctx.fillStyle = 'rgba(170,210,255,0.95)';
    ctx.beginPath();
    ctx.arc(x1, y1, r1, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = 'rgba(255,220,180,0.98)';
    ctx.beginPath();
    ctx.arc(x2, y2, r2, 0, Math.PI*2);
    ctx.fill();
  }

  let last = performance.now();
  let acc = 0;

  function kick() {
    const dir = (Math.random() < 0.5 ? -1 : 1);
    w1 += dir * (2.2 + 1.2*Math.random());
    w2 += -dir * (3.2 + 1.8*Math.random());
  }

  function frame(now) {
    const dtReal = Math.min(0.05, (now - last) / 1000);
    last = now;
    acc += dtReal;

    while (t + 1e-9 >= nextKick) nextKick += 10;
    if (t < nextKick && t + acc >= nextKick) {
      kick();
    }

    const fixed = 1/240;
    let steps = 0;
    while (acc >= fixed && steps < 12) {
      rk4Step(fixed);
      t += fixed;
      acc -= fixed;
      steps++;

      const [,,x2,y2] = pos();
      const c = hueFromOmega(w2);
      trail.push({x:x2,y:y2,c});
      if (trail.length > TRAIL_MAX) trail.splice(0, trail.length - TRAIL_MAX);
    }

    draw();
    requestAnimationFrame(frame);
  }

  requestAnimationFrame(frame);
})();
</script>
</body>
</html>