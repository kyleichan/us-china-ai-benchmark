<!DOCTYPE html>
<html>
<body style="margin:0;background:#111;overflow:hidden;display:flex;justify-content:center;align-items:center;height:100vh;">
<canvas id="c" style="background:#000;box-shadow:0 0 20px #000;"></canvas>
<script>
const c = document.getElementById('c');
const ctx = c.getContext('2d');
c.width = 250; c.height = 400;

// Physics Parameters (SI Units)
const g = 9.81;
const m1 = 1.0, m2 = 1.0;
const l1 = 0.8, l2 = 0.8; // length in meters
const scale = 100; // 100 pixels = 1 meter

// Initial State (Near top)
let s = { t1: Math.PI - 0.01, t2: Math.PI + 0.01, w1: 0, w2: 0 };
let trail = [];
let lastTime = performance.now();
let pushTimer = 0;

// Lagrangian derivatives
function getDerivs(st) {
    let {t1, t2, w1, w2} = st;
    let d = 2 * m1 + m2 - m2 * Math.cos(2 * t1 - 2 * t2);
    
    let n1 = -g * (2 * m1 + m2) * Math.sin(t1) - m2 * g * Math.sin(t1 - 2 * t2) - 2 * Math.sin(t1 - t2) * m2 * (w2 * w2 * l2 + w1 * w1 * l1 * Math.cos(t1 - t2));
    let n2 = 2 * Math.sin(t1 - t2) * (w1 * w1 * l1 * (m1 + m2) + g * (m1 + m2) * Math.cos(t1) + w2 * w2 * l2 * m2 * Math.cos(t1 - t2));
    
    return {
        t1: w1, t2: w2,
        w1: n1 / (l1 * d),
        w2: n2 / (l2 * d)
    };
}

// RK4 Integration
function rk4(st, dt) {
    let k1 = getDerivs(st);
    let k2 = getDerivs({t1: st.t1 + k1.t1*dt/2, t2: st.t2 + k1.t2*dt/2, w1: st.w1 + k1.w1*dt/2, w2: st.w2 + k1.w2*dt/2});
    let k3 = getDerivs({t1: st.t1 + k2.t1*dt/2, t2: st.t2 + k2.t2*dt/2, w1: st.w1 + k2.w1*dt/2, w2: st.w2 + k2.w2*dt/2});
    let k4 = getDerivs({t1: st.t1 + k3.t1*dt, t2: st.t2 + k3.t2*dt, w1: st.w1 + k3.w1*dt, w2: st.w2 + k3.w2*dt});
    
    return {
        t1: st.t1 + dt/6*(k1.t1 + 2*k2.t1 + 2*k3.t1 + k4.t1),
        t2: st.t2 + dt/6*(k1.t2 + 2*k2.t2 + 2*k3.t2 + k4.t2),
        w1: st.w1 + dt/6*(k1.w1 + 2*k2.w1 + 2*k3.w1 + k4.w1),
        w2: st.w2 + dt/6*(k1.w2 + 2*k2.w2 + 2*k3.w2 + k4.w2)
    };
}

function loop(now) {
    let dt = (now - lastTime) / 1000;
    if (dt > 0.05) dt = 0.05; // Cap dt for stability on tab switch
    lastTime = now;

    // Hard push every 10s
    pushTimer += dt;
    if (pushTimer >= 10) {
        s.w1 += (Math.random() < 0.5 ? -1 : 1) * (5 + Math.random() * 5);
        s.w2 += (Math.random() < 0.5 ? -1 : 1) * (5 + Math.random() * 5);
        pushTimer = 0;
    }

    // Physics sub-stepping
    let steps = 8;
    for(let i=0; i<steps; i++) s = rk4(s, dt/steps);

    // Coordinate calculation
    let cx = 125, cy = 170;
    let x1 = cx + l1 * scale * Math.sin(s.t1);
    let y1 = cy + l1 * scale * Math.cos(s.t1);
    let x2 = x1 + l2 * scale * Math.sin(s.t2);
    let y2 = y1 + l2 * scale * Math.cos(s.t2);

    // Trail management
    trail.push({x: x2, y: y2, v: Math.abs(s.w2)});
    if (trail.length > 250) trail.shift();

    // Drawing
    ctx.fillStyle = 'rgba(0,0,0,0.4)'; // Slight fade effect
    ctx.fillRect(0, 0, c.width, c.height);

    // Draw Trail
    if (trail.length > 1) {
        for(let i=0; i<trail.length-1; i++) {
            ctx.beginPath();
            ctx.moveTo(trail[i].x, trail[i].y);
            ctx.lineTo(trail[i+1].x, trail[i+1].y);
            // Map angular velocity to Hue (Blue=Slow -> Red=Fast)
            let hue = 240 - Math.min(trail[i].v * 12, 240);
            ctx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    }

    // Draw Rods
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();

    // Draw Masses
    ctx.fillStyle = '#fff';
    ctx.beginPath(); ctx.arc(cx, cy, 3, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.arc(x1, y1, 6, 0, 7); ctx.fill();
    ctx.beginPath(); ctx.arc(x2, y2, 6, 0, 7); ctx.fill();

    requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>